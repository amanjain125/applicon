{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <li class="breadcrumb-item active">Single Resume Upload</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-upload"></i> Single Resume Upload</h1>
        <p class="lead">Upload one resume and job description for evaluation</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-file-upload"></i> Upload Files</h5>
            </div>
            <div class="card-body">
                <form id="upload-form">
                    <div class="mb-3">
                        <label for="resume" class="form-label">Resume (PDF/DOCX)</label>
                        <input class="form-control" type="file" id="resume" accept=".pdf,.docx" required>
                    </div>
                    <div class="mb-3">
                        <label for="jd" class="form-label">Job Description (TXT)</label>
                        <input class="form-control" type="file" id="jd" accept=".txt" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Evaluate
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-info-circle"></i> Instructions</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Select a resume file (PDF or DOCX format)</li>
                    <li>Select a job description file (TXT format)</li>
                    <li>Click "Evaluate" to process the documents</li>
                    <li>View the detailed relevance score and feedback</li>
                </ol>
                <p class="text-muted">
                    <i class="fas fa-lightbulb"></i> The system will analyze your resume against the job requirements 
                    and provide a relevance score, missing elements, and improvement suggestions.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-chart-pie"></i> Evaluation Result</h5>
            </div>
            <div class="card-body">
                <div id="result-container" class="d-none">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Relevance Score</h6>
                            <div class="progress">
                                <div id="score-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <h1 class="text-center my-3" id="score-value">0</h1>
                            <p class="text-center">
                                <span id="verdict-badge" class="badge bg-secondary">Verdict</span>
                            </p>
                        </div>
                        <div class="col-md-8">
                            <h6>Feedback</h6>
                            <div id="feedback-text"></div>
                            
                            <h6 class="mt-3">Missing Elements</h6>
                            <div id="missing-elements"></div>
                        </div>
                    </div>
                </div>
                <div id="loading" class="d-none text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2">Processing your documents. This may take a moment...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#upload-form').submit(function(e) {
            e.preventDefault();
            
            const resumeFile = $('#resume')[0].files[0];
            const jdFile = $('#jd')[0].files[0];
            
            if (!resumeFile || !jdFile) {
                alert('Please select both files');
                return;
            }
            
            const formData = new FormData();
            formData.append('resume', resumeFile);
            formData.append('jd', jdFile);
            
            // Show loading indicator
            $('#result-container').addClass('d-none');
            $('#loading').removeClass('d-none');
            
            // Submit form
            $.ajax({
                url: '/api/evaluate',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    displayResult(data);
                },
                error: function(xhr) {
                    $('#loading').addClass('d-none');
                    alert('Error: ' + (xhr.responseJSON?.error || 'Failed to process files'));
                }
            });
        });
    });
    
    function displayResult(data) {
        // Hide loading, show result
        $('#loading').addClass('d-none');
        $('#result-container').removeClass('d-none');
        
        // Update score
        $('#score-value').text(data.relevance_score);
        $('#score-bar').css('width', data.relevance_score + '%');
        $('#score-bar').removeClass('bg-success bg-warning bg-danger');
        
        if (data.relevance_score >= 80) {
            $('#score-bar').addClass('bg-success');
            $('#verdict-badge').removeClass('bg-secondary bg-warning bg-danger').addClass('bg-success').text('High');
        } else if (data.relevance_score >= 60) {
            $('#score-bar').addClass('bg-warning');
            $('#verdict-badge').removeClass('bg-secondary bg-success bg-danger').addClass('bg-warning').text('Medium');
        } else {
            $('#score-bar').addClass('bg-danger');
            $('#verdict-badge').removeClass('bg-secondary bg-success bg-warning').addClass('bg-danger').text('Low');
        }
        
        // Update feedback
        $('#feedback-text').html('<p>' + data.feedback + '</p>');
        
        // Update missing elements
        const missingContainer = $('#missing-elements');
        missingContainer.empty();
        
        if (data.missing_elements.must_have_skills.length > 0) {
            missingContainer.append('<p><strong>Missing Required Skills:</strong> ' + 
                data.missing_elements.must_have_skills.join(', ') + '</p>');
        }
        
        if (data.missing_elements.good_to_have_skills.length > 0) {
            missingContainer.append('<p><strong>Missing Preferred Skills:</strong> ' + 
                data.missing_elements.good_to_have_skills.join(', ') + '</p>');
        }
        
        if (data.missing_elements.qualifications.length > 0) {
            missingContainer.append('<p><strong>Missing Qualifications:</strong> ' + 
                data.missing_elements.qualifications.join(', ') + '</p>');
        }
    }
</script>
{% endblock %}