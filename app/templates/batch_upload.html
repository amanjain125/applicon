{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <li class="breadcrumb-item active">Batch Processing</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-copy"></i> Batch Resume Processing</h1>
        <p class="lead">Upload multiple resumes for evaluation against a single job description</p>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-file-upload"></i> Upload Files</h5>
            </div>
            <div class="card-body">
                <form id="batch-upload-form">
                    <div class="mb-3">
                        <label for="jd" class="form-label">Job Description (TXT)</label>
                        <input class="form-control" type="file" id="jd" accept=".txt" required>
                    </div>
                    <div class="mb-3">
                        <label for="resumes" class="form-label">Resumes (PDF/DOCX - Multiple Files)</label>
                        <input class="form-control" type="file" id="resumes" accept=".pdf,.docx" multiple required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="send-emails">
                        <label class="form-check-label" for="send-emails">Send feedback emails to candidates</label>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Process Batch
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-info-circle"></i> Instructions</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Select a job description file (TXT format)</li>
                    <li>Select multiple resume files (PDF or DOCX format)</li>
                    <li>Click "Process Batch" to analyze all resumes</li>
                    <li>View detailed results and export shortlist</li>
                </ol>
                <p class="text-muted">
                    <i class="fas fa-lightbulb"></i> The system will analyze each resume against the job requirements 
                    and provide relevance scores and feedback for all candidates.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title"><i class="fas fa-chart-bar"></i> Batch Results</h5>
            </div>
            <div class="card-body">
                <div id="results-container" class="d-none">
                    <div class="d-flex justify-content-between mb-3">
                        <h6>Processing Results</h6>
                        <button id="export-results" class="btn btn-sm btn-success">
                            <i class="fas fa-file-export"></i> Export CSV
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="results-table">
                            <thead>
                                <tr>
                                    <th>Resume</th>
                                    <th>Score</th>
                                    <th>Verdict</th>
                                    <th>Missing Elements</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="loading" class="d-none text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2">Processing your documents. This may take a moment...</p>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="mt-2">0/0 files processed</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#batch-upload-form').submit(function(e) {
            e.preventDefault();
            
            const jdFile = $('#jd')[0].files[0];
            const resumeFiles = $('#resumes')[0].files;
            const sendEmails = $('#send-emails').is(':checked');
            
            if (!jdFile || !resumeFiles || resumeFiles.length === 0) {
                alert('Please select both job description and at least one resume');
                return;
            }
            
            // Show loading indicator
            $('#results-container').addClass('d-none');
            $('#loading').removeClass('d-none');
            
            // Create FormData
            const formData = new FormData();
            formData.append('jd', jdFile);
            formData.append('send_emails', sendEmails.toString());
            
            // Append all resume files
            for (let i = 0; i < resumeFiles.length; i++) {
                formData.append('resumes', resumeFiles[i]);
            }
            
            // Submit form via AJAX
            $.ajax({
                url: '/api/batch-evaluate',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    const xhr = new window.XMLHttpRequest();
                    // Upload progress
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            const percentComplete = evt.loaded / evt.total * 100;
                            // Update progress bar if needed
                        }
                    }, false);
                    return xhr;
                },
                success: function(data) {
                    displayResults(data);
                    if (data.emails_sent) {
                        alert(`Batch processing complete. ${data.total_processed} resumes processed. Emails sent to candidates.`);
                    }
                },
                error: function(xhr) {
                    $('#loading').addClass('d-none');
                    alert('Error: ' + (xhr.responseJSON?.error || 'Failed to process files'));
                }
            });
        });
        
        $('#export-results').click(function() {
            // Export results to CSV
            exportToCsv();
        });
    });
    
    function displayResults(data) {
        // Hide loading, show results
        $('#loading').addClass('d-none');
        $('#results-container').removeClass('d-none');
        
        // Populate results table
        const tbody = $('#results-table tbody');
        tbody.empty();
        
        data.results.forEach(function(result) {
            const row = `
                <tr>
                    <td>${result.resume_filename}</td>
                    <td>
                        <span class="badge bg-${getScoreBadgeClass(result.relevance_score)}">
                            ${Math.round(result.relevance_score)}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${getVerdictBadgeClass(result.verdict)}">
                            ${result.verdict}
                        </span>
                    </td>
                    <td>
                        ${getMissingElementsSummary(result.missing_elements)}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-details" data-id="${result.evaluation_id}">
                            <i class="fas fa-eye"></i> Details
                        </button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
        
        // Add event listeners for view buttons
        $('.view-details').click(function() {
            const id = $(this).data('id');
            window.location.href = `/evaluation/${id}`;
        });
    }
    
    function getScoreBadgeClass(score) {
        if (score >= 80) return 'success';
        if (score >= 60) return 'warning';
        return 'danger';
    }
    
    function getVerdictBadgeClass(verdict) {
        if (verdict === 'High') return 'success';
        if (verdict === 'Medium') return 'warning';
        return 'danger';
    }
    
    function getMissingElementsSummary(missingElements) {
        if (!missingElements) return 'N/A';
        
        const totalMissing = (missingElements.must_have_skills?.length || 0) + 
                            (missingElements.good_to_have_skills?.length || 0) + 
                            (missingElements.qualifications?.length || 0);
        
        return `${totalMissing} elements missing`;
    }
    
    function exportToCsv() {
        // Simple CSV export functionality
        alert('CSV export functionality would be implemented here');
        // In a real implementation, this would generate and download a CSV file
    }
</script>
{% endblock %}